name: Services

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ "main" ]
    tags: [ 'v*.*.*', '*.*.*' ]
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on:
      group: ${{ matrix.group }}
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      matrix:
        include:
          - arch: linux/arm64
            suffix: arm64
            group: native-builders-arm
          - arch: linux/amd64
            suffix: x86
            group: native-builders-x86

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4.4.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      - name: Build all services
        run: |
          for target in buffer-ng router retina-rtsp replay meta-merge; do
            echo "::group::Building ${target}"
            docker buildx build \
              --target "${target}" \
              -f docker/Dockerfile.services \
              --platform ${{ matrix.arch }} \
              --load \
              -t "savant-${target}:build" \
              .
            echo "::endgroup::"
          done

      - name: Log into registry ${{ env.REGISTRY }}
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tag
        if: github.event_name != 'pull_request'
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "TAG=latest" >> $GITHUB_ENV
          else
            echo "TAG=${{ env.GITHUB_REF_SLUG }}" >> $GITHUB_ENV
          fi

      - name: Tag and push all services
        if: github.event_name != 'pull_request'
        run: |
          SERVICES=(
            "buffer-ng:ghcr.io/insight-platform/savant-buffer-ng-${{ matrix.suffix }}"
            "router:ghcr.io/insight-platform/savant-router-${{ matrix.suffix }}"
            "retina-rtsp:ghcr.io/insight-platform/savant-retina-rtsp-${{ matrix.suffix }}"
            "replay:ghcr.io/insight-platform/savant-replay-${{ matrix.suffix }}"
            "meta-merge:ghcr.io/insight-platform/savant-meta-merge-${{ matrix.suffix }}"
          )
          for entry in "${SERVICES[@]}"; do
            target="${entry%%:*}"
            image="${entry#*:}"
            docker tag "savant-${target}:build" "${image}:${{ env.TAG }}"
            docker push "${image}:${{ env.TAG }}"
          done

      - name: Push rolling release tags
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        run: |
          eval $(docker run --rm --entrypoint /opt/bin/savant_info savant-buffer-ng:build version)

          SERVICES=(
            "buffer-ng:ghcr.io/insight-platform/savant-buffer-ng-${{ matrix.suffix }}"
            "router:ghcr.io/insight-platform/savant-router-${{ matrix.suffix }}"
            "retina-rtsp:ghcr.io/insight-platform/savant-retina-rtsp-${{ matrix.suffix }}"
            "replay:ghcr.io/insight-platform/savant-replay-${{ matrix.suffix }}"
            "meta-merge:ghcr.io/insight-platform/savant-meta-merge-${{ matrix.suffix }}"
          )
          for entry in "${SERVICES[@]}"; do
            target="${entry%%:*}"
            image="${entry#*:}"
            docker tag "savant-${target}:build" "${image}:${SAVANT_RS_VERSION}-rolling"
            docker push "${image}:${SAVANT_RS_VERSION}-rolling"
          done
